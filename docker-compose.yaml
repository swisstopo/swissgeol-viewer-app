services:
  api:
    init: true # handle kill signals for rust
    image: local_api:latest
    build:
      context: ./api
      dockerfile: DockerfileDev
    platform: linux/amd64
    ports:
      - "8480:3000"
    environment:
      SQLX_OFFLINE: true
    command: ["cargo", "watch", "--poll", "--shell", "cargo run --offline --target x86_64-unknown-linux-musl"]
    volumes:
      - ./api/src:/app/src:ro
      - ./api/migrations:/app/migrations:ro
      - ./api/.sqlx:/app/.sqlx:ro
      - ./api/Cargo.toml:/app/Cargo.toml:ro
    links:
      - db

  ui:
    image: node:lts
    ports:
      - 8000:8000
    environment:
      ENVIRONMENT_NAME: local-dev
    working_dir: /app
    command: ['node_modules/.bin/webpack', 'serve']
    links:
      - api
      - abbreviator
    volumes:
      - "./ui:/app:ro"

  minio:
    init: true # handle kill signals
    image: minio/minio:latest
    command: server /data --console-address :9001
    volumes:
      - minio:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_BROWSER: 'on'
      MINIO_SITE_REGION: ${S3_AWS_REGION}
      MINIO_ROOT_USER: ${AWS_ACCESS_KEY_ID}
      MINIO_ROOT_PASSWORD: ${AWS_SECRET_ACCESS_KEY}

  abbreviator:
    image: ghcr.io/swisstopo/swissgeol-viewer-app-abbreviator:main
    platform: linux/amd64
    ports:
      - "8001:8080"
    environment:
      ID_LENGTH: 5
      DATABASE_URL: "sqlite:///storage/local.db"
      HOST_WHITELIST: "localhost"

  db:
    image: camptocamp/postgres:14-postgis-3
    platform: linux/amd64
    environment:
      POSTGRES_USER: ${PGUSER}
      POSTGRES_PASSWORD: ${PGPASSWORD}
      POSTGRES_DB: ${PGDATABASE}
    ports:
      - "15432:5432"
    volumes:
      - db:/var/lib/postgresql/data
    # command: postgres -c log_statement=all for debugging

volumes:
  db:
  minio:
